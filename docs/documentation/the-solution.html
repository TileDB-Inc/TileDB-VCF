<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
  <meta charset="utf-8">
  <meta name="generator" content="quarto-0.9.141">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <title>the-solution</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
  </style>

  <script src="../site_libs/quarto-nav/quarto-nav.js"></script>
  <script src="../site_libs/quarto-nav/headroom.min.js"></script>
  <script src="../site_libs/clipboard/clipboard.min.js"></script>
  <meta name="quarto:offset" content="../">
  <script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
  <script src="../site_libs/quarto-search/fuse.min.js"></script>
  <script src="../site_libs/quarto-search/quarto-search.js"></script>
  <link href="../images/favicon.ico" rel="icon">
  <script src="../site_libs/quarto-html/quarto.js"></script>
  <script src="../site_libs/quarto-html/popper.min.js"></script>
  <script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
  <script src="../site_libs/quarto-html/anchor.min.js"></script>
  <link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
  <link id="quarto-text-highlighting-styles" href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet">
  <script src="../site_libs/bootstrap/bootstrap.min.js"></script>
  <link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
  <link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet">
  <script id="quarto-search-options" type="application/json">{
    "location": "navbar",
    "copy-button": false,
    "collapse-after": 3,
    "panel-placement": "end",
    "type": "overlay",
    "limit": 20,
    "language": {
      "search-no-results-text": "No results",
      "search-matching-documents-text": "matching documents",
      "search-copy-link-title": "Copy link to search",
      "search-hide-matches-text": "Hide additional matches",
      "search-more-match-text": "more match in this document",
      "search-more-matches-text": "more matches in this document",
      "search-clear-button-title": "Clear",
      "search-detached-cancel-button-title": "Cancel",
      "search-submit-button-title": "Submit"
    }
  }</script>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <link rel="stylesheet" href="../quarto-materials/tiledb.css">
</head>
<body class="floating">
<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <a class="navbar-brand" href="../index.html">
    <img src="../quarto-materials/tiledb-logo.png" alt="">
  </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="https://tiledb.com">Home page</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://cloud.tiledb.com/auth/login">Login</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://tiledb.com/contact">Contact us</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://github.com/TileDB-Inc/TileDB-VCF">Repo</a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">(Untitled)</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../documentation/index.html" class="sidebar-item-text sidebar-link">TileDB-VCF</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a href="../documentation/ingestion/overview.html" class="sidebar-item-text sidebar-link">Ingestion</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="" class="collapse list-unstyled sidebar-section depth1 show">  
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../documentation/ingestion/cli.html" class="sidebar-item-text sidebar-link">CLI</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../documentation/ingestion/python.html" class="sidebar-item-text sidebar-link">Python</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../documentation/ingestion/distributed-ingestion.html" class="sidebar-item-text sidebar-link">Distributed Ingestion</a>
  </div>
</li>
    </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc">
<h2 id="toc-title">On this page</h2>
<ul>
<li><a href="#the-solution" class="nav-link active" data-scroll-target="#the-solution">The Solution</a>
<ul class="collapse">
<li><a href="#storing-variants-as-3d-sparse-arrays" class="nav-link" data-scroll-target="#storing-variants-as-3d-sparse-arrays">Storing variants as 3D sparse arrays</a></li>
<li><a href="#fast-retrieval" class="nav-link" data-scroll-target="#fast-retrieval">Fast retrieval</a></li>
<li><a href="#updates" class="nav-link" data-scroll-target="#updates">Updates</a></li>
<li><a href="#easy-and-cost-efficient-scaling" class="nav-link" data-scroll-target="#easy-and-cost-efficient-scaling">Easy and cost-efficient scaling</a></li>
<li><a href="#collaboration" class="nav-link" data-scroll-target="#collaboration">Collaboration</a></li>
<li><a href="#whats-next" class="nav-link" data-scroll-target="#whats-next">What’s next?</a></li>
</ul></li>
</ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/TileDB-Inc/TileDB-VCF/edit/main/documentation/the-solution.md" class="toc-action">Edit this page</a></p><p><a href="https://github.com/TileDB-Inc/TileDB-VCF/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<section id="the-solution" class="level1">
<h1>The Solution</h1>
<section id="storing-variants-as-3d-sparse-arrays" class="level2">
<h2 class="anchored" data-anchor-id="storing-variants-as-3d-sparse-arrays">Storing variants as 3D sparse arrays</h2>
<p>Population variant data can be efficiently represented using a 3D sparse array. For each sample, imagine a 2D plane where the vertical axis is the contig and the horizontal axis is the genomic position. Every variant can be represented as a range within this plane; it can be unary (i.e., a SNP) or it can be a longer range (e.g., INDEL or CNV). Each sample is then indexed by a third dimension, which is unbounded to accommodate populations of any size. The figure below shows an example for one sample, with several variants distributed across contigs <code>chr1</code> , <code>chr2</code> and <code>chr3</code>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../../.gitbook/assets/genomics_representation_start_2%20%283%29.png" class="img-fluid figure-img"></p>
<p></p><figcaption aria-hidden="true" class="figure-caption">3D array representation of population variants</figcaption><p></p>
</figure>
</div>
<p>In TileDB-VCF, we represent the <em>start</em> position of each range as <em>a non-empty cell</em> in a sparse array (black squares in the above figure). In each of those array cells, we store the <em>end</em> position of each cell (to create a range) along with all other fields in the corresponding single-sample VCF files for each variant (e.g., <code>REF</code>, <code>ALT</code>, etc.). Therefore, for every sample, we map variants to 2D non-empty sparse array cells.</p>
<p>To facilitate rapid retrieval of interval intersections (explained in the next section), we also inject <em>anchors</em> (green square in the above figure) to breakup long ranges. Specifically, we create a new non-empty cell every <code>anchor_gap</code> bases from the start of the range (where <code>anchor_gap</code> is a user-defined parameter), which is identical to the range cell, except that (1) it has a new start coordinate and (2) it stores the real start position in an attribute.</p>
<p>Note that regardless of the number of samples, we do not inject any additional information other than that of the anchors, which is user configurable and turns out to be negligible for real datasets. In other words, this solution leads to <em>linear</em> storage in the number of samples, thus being scalable.</p>
</section>
<section id="fast-retrieval" class="level2">
<h2 class="anchored" data-anchor-id="fast-retrieval">Fast retrieval</h2>
<p>The typical access pattern used for variant data involves one or more rectangles covering a set of genomic ranges across one or more samples. In the figure below, let the black rectangle be the user’s query. Observe that the results are highlighted in blue (<code>v1, v2, v4, v7</code>). However, the rectangle misses <code>v1</code>, i.e., the case where an Indel/CNV range <em>intersects</em> the query rectangle, but the start position is <em>outside</em> the rectangle.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../../.gitbook/assets/genomics_retrieval%20%283%29.png" class="img-fluid figure-img"></p>
<p></p><figcaption aria-hidden="true" class="figure-caption">Interval intersection using expanded query ranges and anchors</figcaption><p></p>
</figure>
</div>
<p>This is the motivation behind <em>anchors</em>. TileDB-VCF expands the user’s query range on the left by <code>anchor_gap</code>. It then reports as results the cells that are included in the expanded query if their end position (stored in an attribute) comes after the query range start endpoint. In the example above, TileDB-VCF retrieves anchor <code>a1</code> and Indel/CNV <code>v3</code>. It reports <code>v1</code> as a result (as it can be extracted directly from anchor <code>a1</code>), but filters out <code>v3</code>.</p>
<p>{% hint style=“info” %} By representing each sample’s variants as non-empty cells in a 2D plane and using anchors and expanded queries, we managed to model population variants as 3D sparse arrays and use the vanilla functionality of TileDB-Embedded, inheriting all its powerful features out of the box. {% endhint %}</p>
<p>Quite often, the analyses requires data retrieval based on numerous query ranges (up to the order of millions), which must be submitted simultaneously. TileDB-VCF leverages the highly optimized multi-range subarray functionality of TileDB Embedded, which leads to unparalleled performance for such scenarios.</p>
<p><em>But what about updates?</em> That’s the topic of the next section.</p>
</section>
<section id="updates" class="level2">
<h2 class="anchored" data-anchor-id="updates">Updates</h2>
<p>TileDB-VCF is based on TileDB Embedded which supports <a href="https://docs.tiledb.com/main/solutions/tiledb-embedded/internal-mechanics/writing">rapid updates</a> via <a href="https://docs.tiledb.com/main/basic-concepts/data-format#immutable-fragments">immutable fragments</a>. That means that every time a new batch of samples is added to the 3D array, the previous contents of the array are not modified at all. Each batch write operation is totally independent and _lock-free—_any number of threads or processes can write simultaneously without synchronization, while ensuring consistency. With TileDB-VCF, both update time and storage size scales linearly with the number of new samples, <strong>solving the N+1 problem</strong>.</p>
</section>
<section id="easy-and-cost-efficient-scaling" class="level2">
<h2 class="anchored" data-anchor-id="easy-and-cost-efficient-scaling">Easy and cost-efficient scaling</h2>
<p>TileDB-VCF allows you to efficiently store, update and access enormous population genomic datasets, all <em>open-source</em>. And although it is a C++ embedded library (which works on a single machine), it also integrates very well with Spark and Dask, enabling you to scale your analysis to large clusters. However, the burden of managing clusters (spinning them up, deploying the software, monitoring the resources, etc.), falls entirely on you, which is quite an undertaking.</p>
<p>Enter TileDB Cloud!</p>
<p>TileDB Cloud allows you to perform parallel ingestion and parallel slicing / processing, <strong>100% serverless</strong>. This means that you do not have to spin up large clusters or pay for idle time. You can easily slice data or define complex task flows comprised of thousands of tasks, which TileDB Cloud deploys elastically in its serverless infrastructure, providing an unmatched combination of ease of use and low cost on the cloud—even for your most challenging analyses.</p>
</section>
<section id="collaboration" class="level2">
<h2 class="anchored" data-anchor-id="collaboration">Collaboration</h2>
<p>{% hint style=“info” %} The shear volume of data generated by modern population genomics applications creates enormous challenges around data management and collaboration. {% endhint %}</p>
<p>TileDB Cloud offers groundbreaking features for collaborative genomic research:</p>
<ol type="1">
<li>Popular public datasets made available in the TileDB format for direct analysis</li>
<li>Easy mechanism for one to share their data and code (Jupyter notebooks and user-defined functions), either with a specific set of users or the entire world</li>
<li>Easy ways to explore and discover public data and code.</li>
</ol>
<p><em>Join our vision to build a growing community around open data and code!</em></p>
</section>
<section id="whats-next" class="level2">
<h2 class="anchored" data-anchor-id="whats-next">What’s next?</h2>
<p>If you are familiar with the TileDB Embedded data model, you can delve into the technical details of how TileDB-VCF stores genomic variant data using [D sparse arrays. Otherwise you can proceed with <a href="installation/">installation instructions</a> and tutorials.</p>



</section>
</section>
</main> <!-- /main -->
<script type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    setTimeout(function() {
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->


</body></html>